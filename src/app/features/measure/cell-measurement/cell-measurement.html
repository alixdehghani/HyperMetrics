<div class="max-w-6xl mx-auto p-6 bg-white">
  <div class="mb-4 flex items-center space-x-2">
    <label class="bg-blue-500 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
      Upload JSON
      <input type="file" accept="application/json" (change)="onJsonFileUpload($event)" class="hidden" />
    </label>
  </div>
  <!-- Header -->
  <div class="mb-6 flex items-center justify-between md:flex-row flex-col gap-4">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Measurement Configuration</h1>
      <div class="flex items-center space-x-4 text-gray-600">
        <span><strong>Type:</strong> {{ measurementData.measureType }}</span>
        <span><strong>ID:</strong> {{ measurementData.measureId }}</span>
      </div>
    </div>
    <div class="flex flex-col space-y-2 mt-2">
      @if(getAllErrors().length > 0) {
      <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">‚õî There are
        {{getAllErrors().length}} errors in the configuration. Please fix them before downloading files.</span>
      }
      <button (click)="downloadHyperConfigFiles()"
        class="px-2 py-1 rounded-lg font-medium bg-yellow-500 text-white hover:bg-yellow-600 cursor-pointer text-sm">
        üì• Download Hyper Config File
      </button>
      <button (click)="downloadPropertiesFile()"
        class="px-2 py-1 rounded-lg font-medium bg-yellow-500 text-white hover:bg-yellow-600 cursor-pointer text-sm">
        üì• Download Properties File
      </button>
      <button (click)="downloadENodeB()"
        class="px-2 py-1 rounded-lg font-medium bg-yellow-500 text-white hover:bg-yellow-600 cursor-pointer text-sm">
        üì• Download eNodB No Realtime File
      </button>
      <button (click)="downloadKpiSettingFile()"
        class="px-2 py-1 rounded-lg font-medium bg-yellow-500 text-white hover:bg-yellow-600 cursor-pointer text-sm">
        üì• Download KPI Setting File
      </button>
      <button (click)="downloadDefaultFormulaFile()"
        class="px-2 py-1 rounded-lg font-medium bg-yellow-500 text-white hover:bg-yellow-600 cursor-pointer text-sm">
        üì• Download Default Formula File
      </button>

    </div>
  </div>

  <div class="flex space-x-2 mb-4">
    <button (click)="setViewMode('ui')"
      [ngClass]="viewMode === 'ui' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'"
      class="px-2 py-1 rounded-lg font-medium cursor-pointer text-sm">UI View</button>
    <button (click)="setViewMode('json')"
      [ngClass]="viewMode === 'json' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'"
      class="px-2 py-1 rounded-lg font-medium cursor-pointer text-sm">JSON View</button>
  </div>

  <!-- Content -->
  <ng-container *ngIf="viewMode === 'ui'; else jsonView">
    <div class="mb-6 flex items-center justify-between">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">
        Measurement Objects ({{ measurementData.measureObjList.length }})
      </h2>
      <!-- <div *ngIf="form.dirty" class="text-sm text-red-600">
        You have unsaved changes.
        <button (click)="saveToLocalStorage()"
          class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
          Save Progress
        </button>
      </div> -->
    </div>
    <div class="mb-6 flex items-center justify-between">
      <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="filterMeasurementObjects()"
        placeholder="Search Measurement Objects..."
        class="border border-gray-300 rounded-lg px-4 py-2 w-full max-w-md" />
      <!-- <button (click)="addMeasurementObject()" disabled
        class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
        + Add Measurement Object
      </button> -->
    </div>
    <!-- Replace the existing form tag and its content -->
    <form [formGroup]="form">
      <!-- Header section stays the same -->

      <!-- Measurement Objects -->
      <div formArrayName="measureObjList">
        <div *ngFor="let measureObjControl of getMeasureObjControls(); let i = index" [formGroupName]="i"
          class="border border-gray-300 rounded-lg mb-4">

          <div *ngIf="measurementData.measureObjList[i]._show" class="sticky top-0">
            <div class="flex items-center space-x-3 bg-gray-50 p-4 cursor-pointer hover:bg-gray-100 md:flex-row flex-col items-start"
              (click)="toggleSection('measureObj-' + i)">
              <div>
                <span *ngIf="expandedSections['measureObj-' + i]">‚ñº</span>
                <span *ngIf="!expandedSections['measureObj-' + i]">‚ñ∂</span>
                <span class="text-blue-600">üóÑÔ∏è</span>
              </div>
              <div>
                <h3 class="font-semibold text-lg">{{ measureObjControl.get('name')?.value }} <span
                    *ngIf="measureObjControl.get('abbreviation')?.value">({{measureObjControl.get('abbreviation')?.value}})</span>
                </h3>
                <p class="text-gray-600 text-sm">ID: {{ measurementData.measureObjList[i].measureObjId }}</p>
              </div>
              <div class="flex space-x-2 md:gap-4 mb-3">
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">{{
                  measureObjControl.get('counterList')?.value.length }}
                  Counters</span>
                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">{{
                  measureObjControl.get('kpiList')?.value.length }}
                  KPIs</span>
                <span *ngIf="getAllKpiErrors(measurementData.measureObjList[i]).length > 0"
                  class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">{{getAllKpiErrors(measurementData.measureObjList[i]).length}}
                  Error in KPIs
                </span>
                <span *ngIf="getAllCountersErrors(measurementData.measureObjList[i]).length > 0"
                  class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">{{getAllCountersErrors(measurementData.measureObjList[i]).length}}
                  Error in Counters
                </span>
              </div>
              <!-- <button (click)="removeMeasurementObject(i)"
                class="ml-auto text-red-600 text-sm cursor-pointer">Remove</button> -->
            </div>
            <div *ngIf="expandedSections['measureObj-' + i]" class="p-4 bg-white border-b border-gray-300">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Counters Section -->
                <div>
                  <div class="flex items-center justify-between mb-4">
                    <h4 class="font-semibold text-blue-900">Counters</h4>
                    <!-- <button type="button" (click)="addCounter(measurementData.measureObjList[i])"
                      class="bg-green-500 text-white px-2 py-1 rounded text-xs cursor-pointer">
                      + Add
                    </button> -->
                    <button type="button" [disabled]="addingNewCounter" (click)="startAddingNewCounter()"
                      [ngClass]="addingNewCounter ? 'bg-green-300 text-gray-400 cursor-not-allowed' : 'bg-green-500 text-white cursor-pointer'"
                      class="px-2 py-1 rounded text-xs">
                      + Add new Counter
                    </button>
                  </div>

                  <!-- Search input for counters -->
                  <input type="text" [(ngModel)]="measurementData.measureObjList[i].counterSearchTerm"
                    (ngModelChange)="filterCounters(measurementData.measureObjList[i])"
                    [ngModelOptions]="{standalone: true}" placeholder="Search Counters..."
                    class="border border-blue-300 rounded-lg px-2 py-1 w-full text-sm " />
                </div>
                <!-- KPIs Section -->
                <div>
                  <div class="flex items-center justify-between mb-4">
                    <h4 class="font-semibold text-purple-900">KPIs</h4>
                    <button type="button" [disabled]="addingNewKpi" (click)="startAddingNewKpi()"
                      [ngClass]="addingNewKpi ? 'bg-green-300 text-gray-400 cursor-not-allowed' : 'bg-green-500 text-white cursor-pointer'"
                      class="px-2 py-1 rounded text-xs">
                      + Add new KPI
                    </button>
                  </div>

                  <!-- Search input for KPIs -->
                  <input type="text" [(ngModel)]="measurementData.measureObjList[i].kpiSearchTerm"
                    (ngModelChange)="filterKpis(measurementData.measureObjList[i])"
                    [ngModelOptions]="{standalone: true}" placeholder="Search KPIs..."
                    class="border border-blue-300 rounded-lg px-2 py-1 w-full text-sm mb-3" />
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="expandedSections['measureObj-' + i]" class="p-4">
            <!-- New Counter Form -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <div *ngIf="addingNewCounter" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-3">
                  <form [formGroup]="newCounterForm">
                    <h4 class="font-semibold mb-2">New Counter</h4>
                    <div class="mb-2">
                      <label class="block text-sm font-medium text-gray-700 mb-1">Name:</label>
                      <input formControlName="name" class="border rounded px-2 py-1 w-full font-medium"
                        placeholder="Counter name" />
                    </div>
                    <div class="mb-2">
                      <label class="block text-sm font-medium text-gray-700 mb-1">Cumulative:</label>
                      <select formControlName="cumulative" class="border rounded px-2 py-1 w-full cursor-pointer">
                        <option [ngValue]="true">Cumulative</option>
                        <option [ngValue]="false">Non-cumulative</option>
                      </select>
                    </div>
                    <div class="mb-2">
                      <label class="block text-sm font-medium text-gray-700 mb-1">Unit:</label>
                      <input formControlName="unit" class="border rounded px-2 py-1 w-full" placeholder="Unit" />
                    </div>
                    <div class="flex gap-2">
                      <button (click)="confirmAddNewCounter(measurementData.measureObjList[i])"
                        class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700">
                        Add Counter
                      </button>
                      <button (click)="cancelAddNewCounter()" class="bg-gray-300 px-4 py-1 rounded hover:bg-gray-400">
                        Cancel
                      </button>
                    </div>
                  </form>
                </div>
              </div>

              <div>
                <div *ngIf="addingNewKpi" class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-3">
                  <form [formGroup]="newKpiForm">
                    <h4 class="font-semibold mb-2">New KPI</h4>
                    <div class="mb-2">
                      <label class="block text-sm font-medium text-gray-700 mb-1">Name:</label>
                      <input formControlName="name" class="border rounded px-2 py-1 w-full font-medium"
                        placeholder="KPI name" />
                    </div>
                    <div class="mb-2">
                      <label class="block text-sm font-medium text-gray-700 mb-1">Title:</label>
                      <input formControlName="title" class="border rounded px-2 py-1 w-full font-medium"
                        placeholder="KPI title" />
                    </div>
                    <div class="mb-2">
                      <label class="block text-sm font-medium text-gray-700 mb-1">indicator:</label>
                      <select formControlName="indicator" class="border rounded px-2 py-1 w-full cursor-pointer">
                        <option [ngValue]="'p'">P</option>
                        <option [ngValue]="'n'">N</option>
                      </select>
                    </div>
                    <div class="mb-2">
                      <label class="block text-sm font-medium text-gray-700 mb-1">Unit:</label>
                      <input formControlName="unit" class="border rounded px-2 py-1 w-full" placeholder="Unit" />
                    </div>
                    <div class="mb-2">
                      <label class="block text-sm font-medium text-gray-700 mb-1">Formula:</label>
                      <textarea formControlName="formula" class="border rounded px-2 py-1 w-full" rows="3"
                        placeholder="e.g., (C1 + C2) / C3 * 100"></textarea>
                    </div>
                    <div class="flex gap-2">
                      <button (click)="confirmAddNewKpi(measurementData.measureObjList[i])"
                        class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700">
                        Add KPI
                      </button>
                      <button (click)="cancelAddNewKpi()" class="bg-gray-300 px-4 py-1 rounded hover:bg-gray-400">
                        Cancel
                      </button>
                    </div>
                  </form>
                </div>
              </div>

            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Counters Section -->
              <div formArrayName="counterList">
                <!-- Counters FormArray -->
                <div *ngFor="let counterControl of getCounterControls(i); let ci = index" [formGroupName]="ci">
                  <div *ngIf="measurementData.measureObjList[i].counterList[ci]._show"
                    class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-3">
                    <div class="mb-2 font-semibold flex gap-2">
                      <span class="text-gray-500">Name:</span>
                      <input formControlName="name" class="border rounded px-2 py-1 w-full font-medium mb-2"
                        placeholder="Counter name" />
                      <button *ngIf="editingCounterName[measurementData.measureObjList[i].counterList[ci].id]"
                        (click)="confirmCounterNameChange(counterControl, measurementData.measureObjList[i].counterList[ci])"
                        class="text-green-600 text-sm cursor-pointer">Save</button>
                      <button *ngIf="editingCounterName[measurementData.measureObjList[i].counterList[ci].id]"
                        (click)="cancelCounterEdit(counterControl, measurementData.measureObjList[i].counterList[ci])"
                        class="text-red-600 text-sm cursor-pointer">Cancel</button>
                    </div>
                    <div class="flex justify-between items-center mb-2 flex-wrap gap-2">
                      <div>
                        <span class="text-gray-500">ID:</span>
                        <input value="{{measurementData.measureObjList[i].counterList[ci].id}}" [disabled]="true"
                          class="ml-2 font-mono border rounded px-1 w-30 bg-gray-100 text-gray-500 cursor-not-allowed" />
                      </div>
                      <select formControlName="cumulative" class="border rounded px-1 text-xs cursor-pointer ml-2">
                        <option [ngValue]="true">Cumulative</option>
                        <option [ngValue]="false">Non-cumulative</option>
                      </select>
                      <div>
                        <span class="text-gray-500">Unit:</span>
                        <input formControlName="unit" class="ml-2 border rounded px-1 w-20" />
                      </div>
                    </div>
                    <div
                      *ngIf="getKpisUsingCounter(measurementData.measureObjList[i], measurementData.measureObjList[i].counterList[ci]).length > 0"
                      class="mt-2 px-2 py-2 border border-yellow-500 bg-yellow-50 text-yellow-700 rounded text-xs">
                      ‚ùï This counter is used in:
                      <ul class="list-disc ml-5">
                        <li
                          *ngFor="let kpi of getKpisUsingCounter(measurementData.measureObjList[i], measurementData.measureObjList[i].counterList[ci])">
                          KPI {{ kpi.kpiId }} ‚Äì {{ kpi.name }}
                        </li>
                      </ul>
                      <p class="mt-1">If you delete this counter, remove it from these KPIs first.</p>
                    </div>
                    <div *ngIf="validateCounterName(measurementData.measureObjList[i].counterList[ci]).length > 0"
                      class="bg-red-50 text-red-800 mt-2 px-2 py-2 border border-red-500 bg-red-50 text-red-700 rounded text-xs">
                      <div *ngFor="let err of validateCounterName(measurementData.measureObjList[i].counterList[ci])">
                        ‚õî {{ err }}
                      </div>
                    </div>
                    <button type="button" (click)="removeCounter(measurementData.measureObjList[i], ci)"
                      class="mt-2 text-red-600 text-xs cursor-pointer">
                      Remove
                    </button>
                  </div>
                </div>
              </div>

              <!-- KPIs Section -->
              <div formArrayName="kpiList">
                <!-- KPIs FormArray -->
                <div *ngFor="let kpiControl of getKpiControls(i); let ki = index" [formGroupName]="ki">
                  <div *ngIf="measurementData.measureObjList[i].kpiList[ki]._show"
                    class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-3 flex flex-col gap-4">
                    <div class="mb-2 font-semibold flex gap-2">
                      <span class="text-gray-500">Name:</span>
                      <input formControlName="name" class="border rounded px-1 w-full" placeholder="KPI name" />
                      <button *ngIf="editingKpiName[measurementData.measureObjList[i].kpiList[ki].kpiId]"
                        (click)="confirmKpiNameChange(kpiControl, measurementData.measureObjList[i].kpiList[ki])"
                        class="text-green-600 text-sm cursor-pointer">Save</button>
                      <button *ngIf="editingKpiName[measurementData.measureObjList[i].kpiList[ki].kpiId]"
                        (click)="cancelKpiNameEdit(kpiControl, measurementData.measureObjList[i].kpiList[ki])"
                        class="text-red-600 text-sm cursor-pointer">Cancel</button>
                    </div>
                    <div class="mb-2 font-semibold flex gap-2">
                      <span class="text-gray-500">Title:</span>
                      <input formControlName="title" class="border rounded px-1 w-full" placeholder="KPI Title" />
                      <button *ngIf="editingKpiTitle[measurementData.measureObjList[i].kpiList[ki].kpiId]"
                        (click)="confirmKpiTitleChange(kpiControl, measurementData.measureObjList[i].kpiList[ki])"
                        class="text-green-600 text-sm cursor-pointer">Save</button>
                      <button *ngIf="editingKpiTitle[measurementData.measureObjList[i].kpiList[ki].kpiId]"
                        (click)="cancelKpiTitleEdit(kpiControl, measurementData.measureObjList[i].kpiList[ki])"
                        class="text-red-600 text-sm cursor-pointer">Cancel</button>
                    </div>
                    <div class="flex justify-between items-center mb-3 flex-wrap gap-2">
                      <div>
                        <span class="text-gray-500">KPI ID:</span>
                        <input value="{{measurementData.measureObjList[i].kpiList[ki].kpiId}}" type="number"
                          [disabled]="true"
                          class="ml-2 font-mono border rounded px-1 w-30 bg-gray-100 text-gray-500 cursor-not-allowed" />
                      </div>
                      <div class="flex gap-2 text-xs">
                        <span class="text-gray-500">Indicator:</span>
                        <select formControlName="indicator" class=" border rounded px-1 cursor-pointer">
                          <option value="p">P</option>
                          <option value="n">N</option>
                        </select>
                      </div>
                      <div class="flex gap-2">
                        <span class="text-gray-500">Unit:</span>
                        <input formControlName="unit" class="border rounded px-1 w-20" />
                      </div>
                    </div>

                    <div class="mb-1">
                      <span class="text-gray-500">Formula:</span>
                      <textarea formControlName="formula" class="ml-2 border rounded px-1 w-full" rows="3"></textarea>
                      <div class="flex gap-2">
                        <button *ngIf="editingKpiFormula[measurementData.measureObjList[i].kpiList[ki].kpiId]"
                          (click)="confirmKpiFormulaChange(kpiControl, measurementData.measureObjList[i].kpiList[ki])"
                          class="text-green-600 text-sm cursor-pointer">Save</button>
                        <button *ngIf="editingKpiFormula[measurementData.measureObjList[i].kpiList[ki].kpiId]"
                          (click)="cancelKpiFormulaEdit(kpiControl, measurementData.measureObjList[i].kpiList[ki])"
                          class="text-red-600 text-sm cursor-pointer">Cancel</button>
                      </div>
                    </div>

                    <div class="mb-3">
                      <input disabled="true"
                        value="{{getKpiFormulaForExport(measurementData.measureObjList[i].kpiList[ki])}}"
                        class="ml-2 font-mono border rounded px-1 w-full bg-gray-100 text-gray-500 cursor-not-allowed" />
                    </div>

                    <!-- KPI dependency warning -->
                    <div
                      *ngIf="getCountersUsedByKpi(measurementData.measureObjList[i], measurementData.measureObjList[i].kpiList[ki]).length > 0"
                      class="mt-2 px-2 py-2 border border-yellow-500 bg-yellow-50 text-yellow-700 rounded text-xs">
                      ‚ùï This KPI depends on:
                      <ul class="list-disc ml-5">
                        <li class="mb-1 break-words"
                          *ngFor="let counter of getCountersUsedByKpi(measurementData.measureObjList[i], measurementData.measureObjList[i].kpiList[ki])">
                          Counter {{ counter.id }} ‚Äì {{ counter.name }}
                        </li>
                      </ul>
                      <p class="mt-1">If you delete this KPI, those counters might become unused.</p>
                    </div>
                    <div
                      *ngIf="validateKpiCounters(measurementData.measureObjList[i], measurementData.measureObjList[i].kpiList[ki]).length > 0"
                      class="bg-red-50 text-red-800 mt-2 px-2 py-2 border border-red-500 bg-red-50 text-red-700 rounded text-xs">
                      <div
                        *ngFor="let err of validateKpiCounters(measurementData.measureObjList[i], measurementData.measureObjList[i].kpiList[ki])">
                        ‚õî {{ err }}
                      </div>
                    </div>
                    <div
                      *ngIf="validateFormula(measurementData.measureObjList[i].kpiList[ki].formula, measurementData.measureObjList[i].kpiList[ki]._usedCounters).length > 0"
                      class="bg-red-50 text-red-800 mt-2 px-2 py-2 border border-red-500 bg-red-50 text-red-700 rounded text-xs">
                      <div
                        *ngFor="let err of validateFormula(measurementData.measureObjList[i].kpiList[ki].formula, measurementData.measureObjList[i].kpiList[ki]._usedCounters)">
                        ‚õî {{ err }}
                      </div>
                    </div>
                    <div *ngIf="validateKpiTitle(measurementData.measureObjList[i].kpiList[ki]).length > 0"
                      class="bg-red-50 text-red-800 mt-2 px-2 py-2 border border-red-500 bg-red-50 text-red-700 rounded text-xs">
                      <div *ngFor="let err of validateKpiTitle(measurementData.measureObjList[i].kpiList[ki])">
                        ‚õî {{ err }}
                      </div>
                    </div>

                    <button type="button" (click)="removeKpi(measurementData.measureObjList[i], ki)"
                      class="mt-2 text-red-600 text-xs cursor-pointer self-start">
                      Remove
                    </button>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </form>
  </ng-container>

  <div *ngIf="showRestoreBanner" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded">
    <p class="font-bold">Restore data?</p>
    <p>You have a saved JSON file. Do you want to load it?</p>
    <div class="mt-2 flex gap-2">
      <button (click)="restoreFromLocalStorage()"
        class="bg-yellow-500 text-white px-4 py-1 rounded hover:bg-yellow-600">
        Load
      </button>
      <button (click)="clearLocalStorage()" class="bg-gray-300 px-4 py-1 rounded hover:bg-gray-400">
        Clear
      </button>
    </div>
  </div>
  <!-- JSON View -->
  <ng-template #jsonView>
    <div class="bg-gray-900 text-green-400 p-4 rounded-lg overflow-auto">
      <div class="flex justify-between items-center mb-2">
        <span class="font-semibold text-white">JSON Output</span>
        <button (click)="copyJson()"
          class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 cursor-pointer">
          Copy
        </button>
      </div>
      <pre>{{ form.value | json }}</pre>
    </div>
  </ng-template>
</div>